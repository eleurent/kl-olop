\documentclass{beamer}


\usepackage{etex}
\usepackage{pgffor}
\usepackage[utf8]{inputenc}
%\reserveinserts{28}

\usepackage[backend=biber, citestyle=authoryear, maxcitenames=2, maxbibnames=20]{biblatex}
\bibliography{biblio}

\usepackage{amsmath,amssymb,amsthm,dsfont}
\usepackage{amsfonts}
\usepackage{color}
\usepackage{esint}
\usepackage{stmaryrd}
\usepackage{tabularx}
\usepackage{multirow}
\usepackage[squaren]{SIunits}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage{diagbox}
\usepackage{pdfpages}
\usepackage{dsfont}
\usepackage{xcolor}
\usepackage{soul}
\usepackage[linesnumbered,ruled,vlined]{algorithm2e}
\usepackage{algorithmic}

\usepackage{hyperref}
\usepackage{multimedia}
\usepackage{array}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage{eso-pic}
\usepackage{monster2e}
\usepackage{tikz}
\usepackage{svg}
\usepackage{layout}
\usepackage{xcolor}
\usepackage{fancybox}
\usepackage{setspace}
\usepackage{bbding}
\usepackage{calc}
\usepackage{multicol}
\usepackage[absolute,showboxes,overlay]{textpos}
\usetikzlibrary{calc,fadings,mindmap,trees,arrows,calc,tikzmark,shapes}
\usepackage[flushleft]{threeparttable}

\TPshowboxesfalse
\textblockorigin{0mm}{0mm}
\newcommand{\mathcolorbox}[2]{\colorbox{#1}{$\displaystyle #2$}}

% Icons
\newcommand{\vcenteredinclude}[2]{\begingroup
\setbox0=\hbox{\includesvg[scale=#2]{#1}}%
\parbox{\wd0}{\box0}\endgroup}


% Change margins for slides
\newenvironment{changemargin}[2]{% 
	\begin{list}{}{% 
			\setlength{\topsep}{0pt}% 
			\setlength{\leftmargin}{#1}% 
			\setlength{\rightmargin}{#2}% 
			\setlength{\listparindent}{\parindent}% 
			\setlength{\itemindent}{\parindent}% 
			\setlength{\parsep}{\parskip}% 
		}% 
		\item[]}{\end{list}} 


% Input
\input{style}
\input{../mathdef}

% Style

\TPshowboxesfalse
\textblockorigin{0mm}{0mm}

\setbeamertemplate{footline}{% 
  \hfill% 
  \usebeamercolor[fg]{page number in head/foot}% 
  \usebeamerfont{page number in head/foot}% 
  \insertframenumber%
  %\,/\,\inserttotalframenumber
  \kern1em\vskip2pt% 
}
\beamertemplatenavigationsymbolsempty
\setbeamertemplate{navigation symbols}{}
%\setbeamertemplate{blocks}[rounded]
%\setbeamercolor{block title}{bg=bleu2,fg=white}%bg=background, fg= foreground
%\setbeamercolor{block body}{bg=lightgray}%bg=background, fg= foreground
\renewcommand{\sfdefault}{lmss}
\sffamily
\setbeamersize{text margin left=1cm,text margin right=1cm}


\author[shortname]{
Edouard Leurent \inst{1},\inst{2}, \inst{3} \and 
Odalric-Ambrym Maillard\inst{1} \and 
Denis Efimov \inst{1} \and 
Wilfrid Perruquetti \inst{2} \and 
Yann Blanco \inst{3}}
\institute[shortinst]{\inst{1} Inria SequeL.\and %
                      \inst{2} Inria VALSE. \and 
                      \inst{3} Renault Group.}

\title[]{Safe Reinforcement Learning for Autonomous Driving.}
\date{}
\begin{document}
	
\setbeamertemplate{background canvas}[vertical shading][top=bleu2,middle=bleu2,bottom=bleu1]
\setbeamertemplate{footline}{\hspace{5em} \textcolor{white} {\null \hfill
		\scriptsize Lille, April 2019}\hspace{2em}\null \vspace*{3pt}}
	
	
\begin{frame}
\begin{textblock*}{40mm}[0,0](10mm,0mm)
	\includegraphics[width=3.4cm]{inria/logobleu2}
\end{textblock*}
\begin{textblock*}{40mm}[0,0](14mm,3mm)
	\includegraphics[width=2.6cm]{inria/renault_group}
\end{textblock*}




\begin{textblock*}{11.8cm}(4mm,40mm)
	\vspace{.3cm}
	\textcolor{white} {
		\Large \textbf{\hspace{0.5em}Safe Reinforcement Learning for Decision-Making \\
			\hspace{1.5em} in Autonomous Driving}\\
		{\small %
			\vspace{1cm}
			\hspace{1.5em}\large\textbf{Edouard Leurent, Odalric-Ambrym Maillard, Denis Efimov,}\\
			\hspace{1.4em}\large\textbf{Wilfrid Perruquetti, Yann Blanco}\\
			\hspace{2.5em}SequeL, Inria Lille -- Nord Europe\\
			\hspace{2.5em}Valse, Inria Lille -- Nord Europe\\
			\hspace{2.5em}Renault Group\\
	}}
\end{textblock*}

%\begin{textblock*}{40mm}[0,0](10mm,76mm)
%	\begin{picture}(5,80)
%	\put(0,20){\includegraphics[width=3.8cm,height=1.5cm]{inria/logobasbleuV1}}
%	\put(18,35){
%		\hspace{0.3cm}\textcolor{bleu2}{CONF2019}
%	}
%	\put(18,30){
%		\hspace{-0.07in}\begin{minipage}{30mm}
%		\begin{spacing}{0.5}
%		\textcolor{bleu2}{\scriptsize }
%		\end{spacing}
%		\end{minipage}
%	}
%	\end{picture}
%\end{textblock*}

\vspace*{-4pt}
\end{frame}

\setbeamertemplate{background canvas}[vertical shading][top=blanc, middle=blanc,bottom=blanc]
\setbeamercolor{footlinecolor}{fg=blanc,bg=bleu2}
\setbeamertemplate{footline}
{
\begin{beamercolorbox}[wd=1\paperwidth,ht=15.5pt]{footlinecolor}
		\hspace{3mm}
		\includegraphics[width=14mm]{inria/logobastrans}
		\hspace{.4cm}
		\raisebox{3.2ex}
		{\scriptsize Safe Reinforcement Learning for Autonomous Driving}\hfill
		\raisebox{3.2ex}
		{Lille - \insertframenumber/\inserttotalframenumber \hspace{5mm}
			\null }
\end{beamercolorbox}
}

\begin{frame}{Motivation}


\end{frame}

\begin{frame}{Efficient Planning}
    Look back at the performances of MCTS (actually \texttt{UCT})

    It is quite good, but clearly \hly{sub-optimal}.
    
    \bigskip
    Should we just increase the budget?
    What are some failing cases?
\end{frame}

\begin{frame}{Failing cases of \texttt{UCT}}
    a.k.a the \emph{mousehole} problem
    \begin{center}
    \includegraphics[width=0.8\textwidth]{img/uct_trap}\\
    \bigskip
    \includesvg[width=0.5\textwidth]{img/uct_fail_hw}
    \end{center}
\end{frame}

\begin{frame}{Failing cases of \texttt{UCT}}
    It was analysed in [\cite{Coquelin2007}]
    \begin{center}
    \includegraphics[width=0.8\textwidth]{img/uct_fail}
    \end{center}
    The sample complexity of is lower-bounded by $O(\exp(\exp(D)))$.
\end{frame}

\begin{frame}{A Benchmark of Planning Algorithms}
    \small
    \begin{threeparttable}
    \centering
    \begin{tabular}{cccc}
    \toprule
        Algorithm & Complexity & Does it run? & Does it work?\\
        \midrule
        \texttt{MCTS} & ? & \hlg{YES} & ?\\
        \texttt{SparseSampling}\tnote{1} & $(1/\epsilon)^{\log 1/\epsilon}$ & \hlg{YES} & \hlr{NO} \\
        \texttt{UCT} & $\exp(\exp(D))$ & \hlg{YES} & \hly{KIND OF} \\
        \texttt{OPD}\tnote{2} & $n^{-\frac{\log1/\gamma}{\log \kappa}}$ & \hlg{YES} & \hlg{YES} \\
        \texttt{OLOP} & $n^{-\min(\frac{1}{2}, \frac{\log1/\gamma}{\log \kappa})}$ & \hly{KIND OF} & \hlr{NO} \\
        \texttt{ST0P}\tnote{1} & $(1/\epsilon)^{2+\frac{\log \kappa'}{\log1/\gamma}+o(1)}$ & \hlr{NO} & ? (\hlr{NO})\\
        \texttt{TrailBlazer}\tnote{1} & $(1/\epsilon)^{\frac{\log N\kappa}{\log1/\gamma}}(\log\frac{1}{\delta\epsilon})^\alpha$ & \hlg{YES} & \hlr{NO}\\
        \texttt{PlatYPOOs}\tnote{2} & $\leq$ \texttt{OLOP} & \hlg{YES} & \hlg{YES}\\
        \bottomrule
    \end{tabular}
    
    \begin{tablenotes}
    \item[1] In the PAC framework. 
    \item[2] With deterministic dynamics
    \end{tablenotes}
    \end{threeparttable}
\end{frame}

\begin{frame}{Practical Open Loop Optimistic Planning}
\begin{block}{The idea behind \texttt{OLOP}}
\begin{center}
\includesvg[width=0.6\textwidth]{../img/olop-explain}
\end{center}
\end{block}
\begin{center}
\scalebox{0.7}{
\begin{algorithm}[H]
\DontPrintSemicolon
\footnotesize
\For{each episode $m = 1, \cdots, M$}{
Compute $U_a(m-1)$ from \eqref{eq:Ua} for all $a\in\mathcal{T}$\;
Compute $B_a(m-1)$ from \eqref{eq:Ba} for all $a\in A^L$\;\label{alg:b_values_compute}
Sample a sequence with highest B-value: $a^m \in \argmax_{a\in A^L} B_a(m-1)$.\;
}
\Return the most played sequence $a(n) \in \argmax_{a\in A^L} T_a(M)$
\caption{General structure for Open-Loop Optimistic Planning}
\label{algo:kl-olop}
\end{algorithm}}
\end{center}
\end{frame}

\begin{frame}{Practical Open Loop Optimistic Planning}
\begin{block}{The idea behind \texttt{OLOP}}
\begin{center}
\includesvg[width=0.6\textwidth]{../img/olop-explain-2}
\end{center}
\end{block}
\begin{center}
\scalebox{0.7}{
\begin{algorithm}[H]
\DontPrintSemicolon
\footnotesize
\For{each episode $m = 1, \cdots, M$}{
Compute $U_a(m-1)$ from \eqref{eq:Ua} for all $a\in\mathcal{T}$\;
Compute $B_a(m-1)$ from \eqref{eq:Ba} for all $a\in A^L$\;
Sample a sequence with highest B-value: $a^m \in \argmax_{a\in A^L} B_a(m-1)$.\;
}
\Return the most played sequence $a(n) \in \argmax_{a\in A^L} T_a(M)$
\caption{General structure for Open-Loop Optimistic Planning}
\end{algorithm}}
\end{center}
\end{frame}

\begin{frame}{Practical Open Loop Optimistic Planning}
    \begin{block}{What's wrong with \texttt{OLOP}? }
    Overly pessimistic, especially in the low-budget regime.
    \end{block}
    \begin{equation}
         U^{\mu}_a(m) = \hat{\mu}_a(m) + \sqrt{\frac{2 \log M}{T_a(m)}}
    \end{equation}
    \begin{equation}
    \label{eq:Ua}
        U_a(m) \eqdef \sum_{t=1}^h \gamma^t U^{\mu}_{a_{1:t}}(m) + \frac{\gamma^{h+1}}{1-\gamma}
    \end{equation}
    \begin{equation}
    \label{eq:Ba}
        B_a(m) \eqdef \inf_{1 \leq t \leq L} U_{a_{1:t}}(m)
    \end{equation}
    Intuitive explanation: 
    \begin{itemize}
        \item Unintended behaviour happens when $\hler{U^{\mu}_a(m) > 1}, \forall a$. 
        \item Then the sequence $(U_{a_{1:t}}(m))_t$ is non-decreasing
        \item Then \hlr{$B_a(m) = U_{a_{1:1}}(m)$}
    \end{itemize}
\end{frame}

\begin{frame}{Practical Open Loop Optimistic Planning}
\begin{block}{What we were promised}
\begin{center}
\includesvg[width=0.8\textwidth]{../img/olop-explain-2}
\end{center}
\end{block}
\end{frame}

\begin{frame}{Practical Open Loop Optimistic Planning}
\begin{block}{What we actually got}
\begin{center}
\includesvg[width=0.8\textwidth]{../img/olop-explain-3}
\end{center}
\end{block}
\begin{flushright}
\texttt{OLOP} behaves as \hlr{uniform planning}!
\end{flushright}
\end{frame}

\begin{frame}{Kullback-Leibler Open Loop Optimistic Planning}
    We summon the upper-confidence bound from \texttt{kl-UCB} [\cite{Cappe2013}]:
    \begin{equation*}
        U^{\mu}_a(m) \eqdef \max \left\{q\in I: T_a(m) d(\hat{\mu}_a(m), q) \leq f(m) \right\}
    \end{equation*}
    
    \begin{center}
    \begin{tabular}{ccc}
    \toprule
        Algorithm & \texttt{OLOP} & \texttt{KL-OLOP} \\
        \midrule
        Interval $I$ & $\mathbb{R}$ & [0, 1] \\
        Divergence $d$ & $d_{\texttt{QUAD}}$ & $d_{\texttt{BER}}$ \\
        $f(m)$ & $4 \log M$ & $2\log M + 2 \log\log M$\\
        \bottomrule
    \end{tabular}
    \end{center}
    
    \begin{align*}
    d_{\texttt{QUAD}}(p,q) &\eqdef 2(p-q)^2\\
    d_{\texttt{BER}}(p, q) &\eqdef p \log \frac{p}{q} + (1-p)\log\frac{1-p}{1-q}
    \end{align*}
    
\end{frame}

\begin{frame}{Kullback-Leibler Open Loop Optimistic Planning}
\begin{center}
\vspace{-2em}
    \includegraphics[width=0.6\textwidth]{../img/ukl}
\end{center}
\vspace{-1em}
Conversely,
\begin{itemize}
    \item \hlg{$U^{\mu}_a(m) \in I = [0, 1], \forall a$}. 
    \item The sequence $(U_{a_{1:t}}(m))_t$ is \hlg{non-increasing}
    \item $B_a(m) = U_a(m)$, the \emph{bound sharpening} step is \hlb{superfluous}.
\end{itemize}
\end{frame}

\begin{frame}{Sample complexity}

\texttt{KL-OLOP} introduced and analysed in [\cite{Leurent2019c}].

    \begin{theorem}[Sample complexity]
\label{thm:regret}
\texttt{KL-OLOP} enjoys the same asymptotic regret bounds as \texttt{OLOP}. More precisely, \texttt{KL-OLOP} satisfies:
\begin{equation*}
    \expectedvalue r_n = \begin{cases}
      \tilde{0}\left(n^{-\frac{\log 1/\gamma}{\log \kappa'}}\right), & \text{if}\ \gamma\sqrt{\kappa'} > 1 \\
      \tilde{0}\left(n^{-\frac{1}{2}}\right), & \text{if}\ \gamma\sqrt{\kappa'} \leq 1
    \end{cases}
\end{equation*}
\end{theorem}
\end{frame}

\begin{frame}{Time complexity}
\begin{block}{Original \texttt{KL-OLOP}}
\emph{Compute $B_a(m-1)$ from \eqref{eq:Ba} \hlr{for all $a\in A^L$}}
\end{block}
\begin{block}{Lazy \texttt{KL-OLOP}}
\centering
\includesvg[width=0.6\textwidth]{../img/tree.svg}
\end{block}

\begin{property}[Time and memory complexity]
\begin{equation*}
    \frac{C(\texttt{Lazy KL-OLOP})}{C(\texttt{KL-OLOP})} = \frac{\hleg{nK}}{\hler{K^{L}}}
\end{equation*}
\end{property}
\end{frame}

\begin{frame}{Experiments | Expanded Trees}
    \includesvg[width=\textwidth]{../img/tree_ODP}
\end{frame}

\begin{frame}{Experiments | Expanded Trees}
    \includesvg[width=\textwidth]{../img/tree_OLOP}
\end{frame}

\begin{frame}{Experiments | Expanded Trees}
    \includesvg[width=\textwidth]{../img/tree_KL-OLOP}
\end{frame}

\begin{frame}{Experiments | Highway}
    \includesvg[width=\textwidth]{../img/hw_total_reward}
\end{frame}
\begin{frame}{Experiments | Gridworld}
    \includesvg[width=\textwidth]{../img/gw_return}
\end{frame}
\begin{frame}{Experiments | Stochastic Gridworld}
    \includesvg[width=\textwidth]{../img/gw_stoch_return}
\end{frame}

\begin{frame}[allowframebreaks]
        \frametitle{References}
        \printbibliography
\end{frame}

\end{document}

